(function(a){a.fn.smartAutoComplete=function(){if(arguments.length<1){var c=this[0];return a(c).data("smart-autocomplete")}var b=function(g,h,f){var i=new RegExp(g.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"i");return a.grep(h,function(j){return i.test(j)})};var e={minCharLimit:1,maxCharLimit:null,maxResults:null,delay:0,disabled:false,forceSelect:false,typeAhead:false,resultElement:"li",resultFormatter:function(f){return("<li>"+f+"</li>")},filter:function(i,j){var h=this;var f=a(h).data("smart-autocomplete");if(a.type(j)==="array"){var g=b(i,j,h);return g}else{if(a.type(j)==="string"){return a.Deferred(function(k){a.ajax({url:j,data:{term:i},dataType:"json"}).done(function(l){k.resolve(b(i,l,h))})}).promise()}}},alignResultsContainer:false,clearResults:function(){var f=a(this.context).prev(".smart_autocomplete_type_ahead_field");a(this.context).css({background:f.css("background")});f.remove();a(this.resultsContainer).html("")},setCurrentSelectionToContext:function(){if(this.rawResults.length>0&&this.currentSelection>=0){a(this.context).val(this.rawResults[(this.currentSelection)])}},setItemSelected:function(f){this.itemSelected=f},autocompleteFocused:false,setAutocompleteFocused:function(f){this.autocompleteFocused=f}};a.event.special.keyIn={setup:function(){return false},_default:function(i){var g=i.target;var f=a(g).data("smart-autocomplete");var l=f.source||null;var h=f.filter;var k=(f.maxCharLimit>0?f.maxCharLimit:Number.POSITIVE_INFINITY);var j=i.smartAutocompleteData.query;if(f.disabled||(j.length>k)){a(g).trigger("lostFocus");return false}f.setItemSelected(false);f.setAutocompleteFocused(true);setTimeout(function(){a.when(h.apply(f,[j,f.source,g])).done(function(m){var n=(f.maxResults>0?m.splice(0,f.maxResults):m);a(g).trigger("resultsReady",[n])})},f.delay)}};a.event.special.resultsReady={setup:function(){return false},_default:function(j){var i=j.target;var f=a(i).data("smart-autocomplete");var h=j.smartAutocompleteData.results;if(f.disabled){return false}a(i).smartAutoComplete().clearResults();f.rawResults=h;if(h.length<1){a(i).trigger("noResults");return false}var g=a.map(h,function(l){return f.resultFormatter.apply(f,[l])});var k=g.join("");if(f.resultsContainer){a(f.resultsContainer).append(k)}a(i).trigger("showResults",[h])}};a.event.special.showResults={setup:function(){return false},_default:function(k){var i=k.target;var g=a(i).data("smart-autocomplete");var h=a(g.resultsContainer);var j=k.smartAutocompleteData.results;if(g.typeAhead&&(j[0].substr(0,a(i).val().length)==a(i).val())){var f=j[0];a(i).before("<input class='smart_autocomplete_type_ahead_field' type='text' autocomplete='off' disabled='disabled' value='"+f+"'/>");a(i).css({position:"relative",zIndex:2,background:"transparent"});var l=a(i).prev("input");l.css({position:"absolute",zIndex:1,overflow:"hidden",background:a(i).css("background"),borderColor:"transparent",width:a(i).width(),color:"silver"});g.currentSelection=0;if(h){a(i).trigger("itemFocus",h.children()[g.currentSelection])}}if(h){if(g.alignResultsContainer){h.css({position:"absolute",top:function(){return a(i).offset().top+a(i).height()},left:function(){return a(i).offset().left},width:function(){return a(i).width()},zIndex:1000})}h.show()}}};a.event.special.noResults={setup:function(){return false},_default:function(i){var h=i.target;var g=a(h).data("smart-autocomplete");var f=a(g.resultsContainer);if(f){g.clearResults()}}};a.event.special.itemSelect={setup:function(){return false},_default:function(j){var g=j.target;var f=a(g).data("smart-autocomplete");var i=j.smartAutocompleteData.item;var h=a(i).text()||a(i).val();a(g).val(h);f.setItemSelected(true);f.originalCharCount=a(g).val().length;a(g).trigger("lostFocus")}};a.event.special.itemFocus={setup:function(){return false},_default:function(g){var f=g.smartAutocompleteData.item;a(f).addClass("smart_autocomplete_highlight")}};a.event.special.itemUnfocus={setup:function(){return false},_default:function(g){var f=g.smartAutocompleteData.item;a(f).removeClass("smart_autocomplete_highlight")}};a.event.special.lostFocus={setup:function(){return false},_default:function(h){var g=h.target;var f=a(g).data("smart-autocomplete");if(f.forceSelect&&!f.itemSelected){a(f.context).val("")}f.setAutocompleteFocused(false);f.clearResults();if(f.resultsContainer){a(f.resultsContainer).hide()}f.currentSelection=null}};var d=arguments[0];return this.each(function(g){var f=a.extend(e,a(this).data("smart-autocomplete"),d);f.context=this;if(a.type(f.resultsContainer)==="undefined"){var h=a("<ul class='smart_autocomplete_container' style='display:none'></ul>");h.appendTo("body");f.resultsContainer=h;f.alignResultsContainer=true}a(this).data("smart-autocomplete",f);a(this).on("keyup",function(m){var j=a(this).data("smart-autocomplete");if(m.keyCode===38){if(j.resultsContainer){var i=j.currentSelection||0;var k=a(j.resultsContainer).children();if(i>0){a(j.context).trigger("itemUnfocus",k[i]);i--}else{if((i-1)<0){a(j.context).trigger("itemUnfocus",k[i]);i=k.length-1}}j.currentSelection=i;a(j.context).trigger("itemFocus",[k[i]])}}else{if(m.keyCode===40){if(j.resultsContainer&&j.resultsContainer.is(":visible")){var i=j.currentSelection;var k=a(j.resultsContainer).children();if(i>=0){a(j.context).trigger("itemUnfocus",k[i])}if(isNaN(i)||null==i||(++i>=k.length)){i=0}j.currentSelection=i;a(j.context).trigger("itemFocus",[k[i]])}else{a(j.context).trigger("keyIn",[a(this).val()])}}else{if(m.keyCode===39||m.keyCode===13){var n=a(j.context).prev(".smart_autocomplete_type_ahead_field");if(j.resultsContainer&&a(j.resultsContainer).is(":visible")){var i=j.currentSelection;var k=a(j.resultsContainer).children();a(j.context).trigger("itemSelect",[k[i]])}else{if(j.typeAhead&&n.is(":visible")){a(j.context).trigger("itemSelect",[n])}}return false}else{if(m.keyCode!==255){var l=a(j.context).val().length;if(j.originalCharCount==l){return}if(l>=j.minCharLimit){a(j.context).trigger("keyIn",[a(this).val()])}else{if(j.autocompleteFocused){j.currentSelection=null;a(j.context).trigger("lostFocus")}}}}}}});a(this).focus(function(){a(this).closest("form").bind("keydown.block_for_smart_autocomplete",function(k){var l=a(f.context).prev(".smart_autocomplete_type_ahead_field");if(k.keyCode===13){if(f.resultsContainer&&a(f.resultsContainer).is(":visible")){var i=f.currentSelection;var j=a(f.resultsContainer).children();a(f.context).trigger("itemSelect",[j[i]]);return false}else{if(f.typeAhead&&l.is(":visible")){a(f.context).trigger("itemSelect",[l]);return false}}}});if(f.forceSelect){a(this).select()}});a(document).bind("focusin click",function(j){if(f.autocompleteFocused){var i=a.contains(f.resultsContainer[0],j.target);if(j.target==f.resultsContainer[0]||j.target==f.context||i){return}a(f.context).closest("form").unbind("keydown.block_for_smart_autocomplete");a(f.context).trigger("lostFocus")}});a(f.resultsContainer).delegate(f.resultElement,"mouseenter.smart_autocomplete",function(){var i=f.currentSelection||0;var j=a(f.resultsContainer).children();f.currentSelection=a(this).prevAll().length;if(i!=f.currentSelection){a(f.context).trigger("itemUnfocus",j[i])}a(f.context).trigger("itemFocus",[this])});a(f.resultsContainer).delegate(f.resultElement,"mouseleave.smart_autocomplete",function(){a(f.context).trigger("itemUnfocus",[this])});a(f.resultsContainer).delegate(f.resultElement,"mousedown.smart_autocomplete",function(){a(f.context).trigger("itemSelect",[this]);return false});a(this).bind({keyIn:function(i,j){i.smartAutocompleteData={query:j}},resultsReady:function(j,i){j.smartAutocompleteData={results:i}},showResults:function(j,i){j.smartAutocompleteData={results:i}},noResults:function(){},lostFocus:function(){},itemSelect:function(j,i){j.smartAutocompleteData={item:i}},itemFocus:function(j,i){j.smartAutocompleteData={item:i}},itemUnfocus:function(j,i){j.smartAutocompleteData={item:i}}})})}})(jQuery);